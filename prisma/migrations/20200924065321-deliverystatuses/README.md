# Migration `20200924065321-deliverystatuses`

This migration has been generated by winsonhys at 9/24/2020, 2:53:21 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "DeliveryStatus" AS ENUM ('PREPARING', 'READY', 'SHIPPED', 'RECEIVED')

CREATE TABLE "public"."MultiOrderDeliveryStatus" (
"id" text   NOT NULL ,
"addressId" text   NOT NULL ,
"paymentMultiOrderId" text   NOT NULL ,
"status" "DeliveryStatus"  NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."OrderDeliveryStatus" (
"id" text   NOT NULL ,
"addressId" text   NOT NULL ,
"paymentOrderId" text   NOT NULL ,
"status" "DeliveryStatus"  NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."OrderDeliveryStatusDescription" (
"id" text   NOT NULL ,
"timestamp" timestamp(3)   NOT NULL ,
"description" text   NOT NULL ,
"orderDeliveryStatusId" text   ,
"multiOrderDeliveryStatusId" text   ,
PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "OrderDeliveryStatus_paymentOrderId_unique" ON "public"."OrderDeliveryStatus"("paymentOrderId")

ALTER TABLE "public"."MultiOrderDeliveryStatus" ADD FOREIGN KEY ("addressId")REFERENCES "public"."Address"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."MultiOrderDeliveryStatus" ADD FOREIGN KEY ("paymentMultiOrderId")REFERENCES "public"."PaymentMultiOrder"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."OrderDeliveryStatus" ADD FOREIGN KEY ("addressId")REFERENCES "public"."Address"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."OrderDeliveryStatus" ADD FOREIGN KEY ("paymentOrderId")REFERENCES "public"."PaymentOrder"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."OrderDeliveryStatusDescription" ADD FOREIGN KEY ("orderDeliveryStatusId")REFERENCES "public"."OrderDeliveryStatus"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."OrderDeliveryStatusDescription" ADD FOREIGN KEY ("multiOrderDeliveryStatusId")REFERENCES "public"."MultiOrderDeliveryStatus"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200923075630-order-item-count..20200924065321-deliverystatuses
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider        = "prisma-client-js"
@@ -22,8 +22,17 @@
   PAID
   REFUNDED
 }
+enum DeliveryStatus {
+  PREPARING
+  READY
+  SHIPPED
+  RECEIVED
+}
+
+// User
+
 model User {
   id               String    @default(uuid()) @id
   email            String    @unique
   username         String    @unique
@@ -37,19 +46,23 @@
 }
 model Address {
-  id          String @default(uuid()) @id
-  country     String
-  city        String
-  state       String
-  line1       String
-  line2       String
-  postal_code String
-  userId      String
-  user        User   @relation(fields: [userId], references: [id])
+  id                       String                     @default(uuid()) @id
+  country                  String
+  city                     String
+  state                    String
+  line1                    String
+  line2                    String
+  postal_code              String
+  userId                   String
+  user                     User                       @relation(fields: [userId], references: [id])
+  OrderDeliveryStatus      OrderDeliveryStatus[]
+  MultiOrderDeliveryStatus MultiOrderDeliveryStatus[]
 }
+// Shop
+
 model Shop {
   id        String     @default(uuid()) @id
   email     String     @unique
   username  String     @unique
@@ -69,8 +82,9 @@
   orderItemCounts OrderItemCount[]
   refunds         Refund[]
 }
+// Orders
 model MultiOrder {
   id                String             @default(uuid()) @id
   orders            Order[]
   paymentIntentId   String?
@@ -100,22 +114,26 @@
   count     Int
   deletedAt DateTime?
 }
+// Payments
+
 model PaymentOrder {
-  id              String        @default(uuid()) @id
-  paymentStatus   PaymentStatus @default(UNPAID)
-  orderId         String
-  order           Order         @relation(fields: [orderId], references: [id])
-  paymentIntentId String
+  id                  String               @default(uuid()) @id
+  paymentStatus       PaymentStatus        @default(UNPAID)
+  orderId             String
+  order               Order                @relation(fields: [orderId], references: [id])
+  paymentIntentId     String
+  orderDeliveryStatus OrderDeliveryStatus?
 }
 model PaymentMultiOrder {
-  id              String        @default(uuid()) @id
-  paymentStatus   PaymentStatus @default(UNPAID)
-  multiOrderId    String
-  multiOrder      MultiOrder    @relation(fields: [multiOrderId], references: [id])
-  paymentIntentId String
+  id                       String                     @default(uuid()) @id
+  paymentStatus            PaymentStatus              @default(UNPAID)
+  multiOrderId             String
+  multiOrder               MultiOrder                 @relation(fields: [multiOrderId], references: [id])
+  paymentIntentId          String
+  MultiOrderDeliveryStatus MultiOrderDeliveryStatus[]
 }
 model Refund {
   id              String   @default(uuid()) @id
@@ -124,4 +142,35 @@
   description     String
   paymentIntentId String
   stripeRefundId  String
 }
+
+// Delivery
+model MultiOrderDeliveryStatus {
+  id                  String                           @default(uuid()) @id
+  addressId           String
+  Address             Address                          @relation(fields: [addressId], references: [id])
+  paymentMultiOrderId String
+  PaymentMultiOrder   PaymentMultiOrder                @relation(fields: [paymentMultiOrderId], references: [id])
+  status              DeliveryStatus
+  description         OrderDeliveryStatusDescription[]
+}
+
+model OrderDeliveryStatus {
+  id             String                           @default(uuid()) @id
+  addressId      String
+  Address        Address                          @relation(fields: [addressId], references: [id])
+  paymentOrderId String
+  paymentOrder   PaymentOrder                     @relation(fields: [paymentOrderId], references: [id])
+  status         DeliveryStatus
+  description    OrderDeliveryStatusDescription[]
+}
+
+model OrderDeliveryStatusDescription {
+  id                         String                    @default(uuid()) @id
+  timestamp                  DateTime
+  description                String
+  OrderDeliveryStatus        OrderDeliveryStatus?      @relation(fields: [orderDeliveryStatusId], references: [id])
+  orderDeliveryStatusId      String?
+  MultiOrderDeliveryStatus   MultiOrderDeliveryStatus? @relation(fields: [multiOrderDeliveryStatusId], references: [id])
+  multiOrderDeliveryStatusId String?
+}
```


