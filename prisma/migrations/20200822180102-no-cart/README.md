# Migration `20200822180102-no-cart`

This migration has been generated by winsonhys at 8/23/2020, 2:01:02 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."Cart" DROP CONSTRAINT "Cart_multiCartId_fkey"

ALTER TABLE "public"."Cart" DROP CONSTRAINT "Cart_ownerId_fkey"

ALTER TABLE "public"."CartItemCount" DROP CONSTRAINT "CartItemCount_cartId_fkey"

ALTER TABLE "public"."CartItemCount" DROP COLUMN "cartId",
ADD COLUMN "orderId" text   NOT NULL 

CREATE TABLE "public"."MultiOrder" (
"id" text   NOT NULL ,
"paymentIntentId" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Order" (
"id" text   NOT NULL ,
"ownerId" text   NOT NULL ,
"paymentIntentId" text   ,
"price" Decimal(65,30)   NOT NULL DEFAULT 0,
"multiOrderId" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."PaymentOrder" (
"id" text   NOT NULL ,
"paymentStatus" "PaymentStatus"  NOT NULL DEFAULT E'UNPAID',
"orderId" text   NOT NULL ,
"paymentIntentId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."PaymentMultiOrder" (
"id" text   NOT NULL ,
"paymentStatus" "PaymentStatus"  NOT NULL DEFAULT E'UNPAID',
"multiOrderId" text   NOT NULL ,
"paymentIntentId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Refund" (
"id" text   NOT NULL ,
"shopItemId" text   NOT NULL ,
"description" text   NOT NULL ,
"paymentIntentId" text   NOT NULL ,
"stripeRefundId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "Order_ownerId_unique" ON "public"."Order"("ownerId")

CREATE UNIQUE INDEX "PaymentOrder_orderId_unique" ON "public"."PaymentOrder"("orderId")

CREATE UNIQUE INDEX "PaymentMultiOrder_multiOrderId_unique" ON "public"."PaymentMultiOrder"("multiOrderId")

CREATE UNIQUE INDEX "CartItemCount_orderId_unique" ON "public"."CartItemCount"("orderId")

ALTER TABLE "public"."Order" ADD FOREIGN KEY ("ownerId")REFERENCES "public"."UserTable"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Order" ADD FOREIGN KEY ("multiOrderId")REFERENCES "public"."MultiOrder"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."PaymentOrder" ADD FOREIGN KEY ("orderId")REFERENCES "public"."Order"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."PaymentMultiOrder" ADD FOREIGN KEY ("multiOrderId")REFERENCES "public"."MultiOrder"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Refund" ADD FOREIGN KEY ("shopItemId")REFERENCES "public"."ShopItem"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CartItemCount" ADD FOREIGN KEY ("orderId")REFERENCES "public"."Order"("id") ON DELETE CASCADE ON UPDATE CASCADE

DROP TABLE "public"."Cart"

DROP TABLE "public"."MultiCart"

ALTER INDEX "public"."Shop.email" RENAME TO "Shop.email_unique"

ALTER INDEX "public"."Shop.username" RENAME TO "Shop.username_unique"

ALTER INDEX "public"."UserTable.email" RENAME TO "UserTable.email_unique"

ALTER INDEX "public"."UserTable.username" RENAME TO "UserTable.username_unique"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200817173559-paid-status..20200822180102-no-cart
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider             = "prisma-client-js"
@@ -28,9 +28,9 @@
   email          String   @unique
   username       String   @unique
   password       String
   dob            DateTime
-  cart           Cart
+  cart           Order
   stripe_cust_id String   @default("")
   @@map("UserTable")
 }
@@ -51,35 +51,61 @@
   imageUrl       String
   shop           Shop            @relation(fields: [shopId], references: [id])
   shopId         String
   cartItemCounts CartItemCount[]
+  refunds        Refund[]
 }
-model MultiCart {
-  id              String        @default(uuid()) @id
-  carts           Cart[]
-  paymentIntentId String?
-  paymentStatus   PaymentStatus @default(UNPAID)
+model MultiOrder {
+  id                String             @default(uuid()) @id
+  orders            Order[]
+  paymentIntentId   String?
+  PaymentMultiOrder PaymentMultiOrder?
 }
-model Cart {
-  id              String          @default(uuid()) @id
+model Order {
+  id              String        @default(uuid()) @id
   ownerId         String
-  owner           User            @relation(fields: [ownerId], references: [id])
+  owner           User          @relation(fields: [ownerId], references: [id])
   paymentIntentId String?
-  price           Float           @default(0)
-  cartItemCounts  CartItemCount[]
-  MultiCart       MultiCart?      @relation(fields: [multiCartId], references: [id])
-  multiCartId     String?
-  paymentStatus   PaymentStatus   @default(UNPAID)
+  price           Float         @default(0)
+  cartItemCount   CartItemCount
+  MultiOrder      MultiOrder?   @relation(fields: [multiOrderId], references: [id])
+  multiOrderId    String?
+  PaymentOrder    PaymentOrder?
 }
 model CartItemCount {
   id        String    @default(uuid()) @id
-  cartId    String
-  cart      Cart      @relation(fields: [cartId], references: [id])
+  orderId   String
+  order     Order     @relation(fields: [orderId], references: [id])
   itemId    String
   shopItem  ShopItem  @relation(fields: [itemId], references: [id])
   price     Float
   count     Int
   deletedAt DateTime?
 }
+
+model PaymentOrder {
+  id              String        @default(uuid()) @id
+  paymentStatus   PaymentStatus @default(UNPAID)
+  orderId         String
+  order           Order         @relation(fields: [orderId], references: [id])
+  paymentIntentId String
+}
+
+model PaymentMultiOrder {
+  id              String        @default(uuid()) @id
+  paymentStatus   PaymentStatus @default(UNPAID)
+  multiOrderId    String
+  multiOrder      MultiOrder    @relation(fields: [multiOrderId], references: [id])
+  paymentIntentId String
+}
+
+model Refund {
+  id              String   @default(uuid()) @id
+  shopItem        ShopItem @relation(fields: [shopItemId], references: [id])
+  shopItemId      String
+  description     String
+  paymentIntentId String
+  stripeRefundId  String
+}
```


